<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yunche.loan.mapper.LoanStatementDOMapper">
    <select id="statisticsTelephoneVerifyNodeOrders" parameterType="com.yunche.loan.domain.param.TelephoneVerifyParam" resultType="com.yunche.loan.domain.vo.TelephoneVerifyNodeOrdersVO">
        SELECT
        tab.*
        FROM
        (
        SELECT
        process.gmt_create AS ct,
        process.gmt_modify AS mt,
        process.telephone_verify,
        plan.bank_period_principal,
        plan.bank,
        CASE

        WHEN process.telephone_verify = 2 THEN
        '待处理'
        WHEN process.telephone_verify = 12 THEN
        '弃单'
        WHEN process.telephone_verify = 4 THEN
        '电审专员提交'
        WHEN process.telephone_verify = 5 THEN
        '电审组长提交'
        WHEN process.telephone_verify = 6 THEN
        '电审主管提交'
        WHEN process.telephone_verify = 7 THEN
        '电审总监提交'
        WHEN process.telephone_verify = 1 THEN
        CASE

        WHEN (
        SELECT
        max( g.telephone_verify_level )
        FROM
        employee_rela_user_group ug
        LEFT JOIN user_group g ON ug.user_group_id = g.id
        WHERE
        ug.employee_id = ( SELECT user_id FROM loan_process_log WHERE task_definition_key = 'usertask_telephone_verify' AND order_id = orders.id ORDER BY create_time DESC LIMIT 1 )
        ) = 7 THEN
        '电审总监过单'
        WHEN (
        SELECT
        max( g.telephone_verify_level )
        FROM
        employee_rela_user_group ug
        LEFT JOIN user_group g ON ug.user_group_id = g.id
        WHERE
        ug.employee_id = ( SELECT user_id FROM loan_process_log WHERE task_definition_key = 'usertask_telephone_verify' AND order_id = orders.id ORDER BY create_time DESC LIMIT 1 )
        ) = 6 THEN
        '电审主管过单'
        WHEN (
        SELECT
        max( g.telephone_verify_level )
        FROM
        employee_rela_user_group ug
        LEFT JOIN user_group g ON ug.user_group_id = g.id
        WHERE
        ug.employee_id = ( SELECT user_id FROM loan_process_log WHERE task_definition_key = 'usertask_telephone_verify' AND order_id = orders.id ORDER BY create_time DESC LIMIT 1 )
        ) = 5 THEN
        '电审组长过单'
        WHEN (
        SELECT
        max( g.telephone_verify_level )
        FROM
        employee_rela_user_group ug
        LEFT JOIN user_group g ON ug.user_group_id = g.id
        WHERE
        ug.employee_id = ( SELECT user_id FROM loan_process_log WHERE task_definition_key = 'usertask_telephone_verify' AND order_id = orders.id ORDER BY create_time DESC LIMIT 1 )
        ) = 4 THEN
        '电审专员过单' ELSE '异常提交'
        END ELSE '待处理'
        END AS commit_status,
        orders.id AS order_id,
        customer.NAME AS customer_name,
        '身份证' AS customer_card_type,
        customer.id_card AS customer_id_card,
        saleman.NAME AS saleman_name,
        partner.NAME AS partner_name,
        department.NAME AS saleman_department_name,
        plan.loan_amount AS loan_amount,
        CASE

        WHEN ( SELECT count( order_id ) FROM install_gps GROUP BY order_id HAVING order_id = orders.id ) IS NULL THEN
        0 ELSE ( SELECT count( order_id ) FROM install_gps GROUP BY order_id HAVING order_id = orders.id )
        END AS gps_number,
        ( SELECT NAME FROM employee WHERE id = ( SELECT user_id FROM loan_process_log WHERE task_definition_key = 'usertask_telephone_verify' AND order_id = orders.id ORDER BY create_time DESC LIMIT 1 ) ) AS op_user_name,
        ( SELECT create_time FROM loan_process_log WHERE task_definition_key = 'usertask_telephone_verify' AND order_id = orders.id ORDER BY create_time DESC LIMIT 1 ) op_time,
        CASE

        WHEN ( SELECT credit_result FROM loan_process_log WHERE task_definition_key = 'usertask_telephone_verify' AND order_id = orders.id ORDER BY create_time DESC LIMIT 1 ) = 1 THEN
        '通过'
        WHEN ( SELECT credit_result FROM loan_process_log WHERE task_definition_key = 'usertask_telephone_verify' AND order_id = orders.id ORDER BY create_time DESC LIMIT 1 ) = 1 THEN
        '通融通过' ELSE '待审核'
        END AS result,
        ( SELECT info FROM loan_process_log WHERE task_definition_key = 'usertask_telephone_verify' AND order_id = orders.id ORDER BY create_time DESC LIMIT 1 ) op_info,
        CASE
        WHEN process.telephone_verify = 2 then '待审核'

        WHEN ( SELECT action FROM loan_process_log WHERE task_definition_key = 'usertask_telephone_verify' AND order_id = orders.id ORDER BY create_time DESC LIMIT 1 ) = 3 THEN
        '资料增补'
        WHEN ( SELECT action FROM loan_process_log WHERE task_definition_key = 'usertask_telephone_verify' AND order_id = orders.id ORDER BY create_time DESC LIMIT 1 ) = 2 THEN
        '弃单'
        WHEN ( SELECT action FROM loan_process_log WHERE task_definition_key = 'usertask_telephone_verify' AND order_id = orders.id ORDER BY create_time DESC LIMIT 1 ) = 1 THEN
        '通过'
        WHEN ( SELECT action FROM loan_process_log WHERE task_definition_key = 'usertask_telephone_verify' AND order_id = orders.id ORDER BY create_time DESC LIMIT 1 ) = 0 THEN
        CASE

        WHEN process.telephone_verify IN ( 2, 4, 5, 6, 7 ) THEN
        '待审核' ELSE
        CASE

        WHEN ( SELECT count( 1 ) FROM loan_reject_log WHERE reject_origin_task = 'usertask_telephone_verify' AND order_id = process.order_id AND gmt_create BETWEEN process.gmt_create AND process.gmt_modify ) = 0 THEN
        '待审核' ELSE '已打回'
        END
        END ELSE '未知'
        END AS action,
        partner.id as partner_id,
        car.car_type

        FROM
        loan_order orders
        LEFT JOIN loan_process process ON orders.id = process.order_id
        LEFT JOIN loan_base_info baseinfo ON orders.loan_base_info_id = baseinfo.id
        LEFT JOIN loan_customer customer ON customer.id = orders.loan_customer_id
        LEFT JOIN loan_financial_plan plan ON plan.id = orders.loan_financial_plan_id
        LEFT join loan_car_info car on car.id = orders.loan_car_info_id
        LEFT JOIN partner partner ON baseinfo.partner_id = partner.id
        LEFT JOIN employee saleman ON baseinfo.salesman_id = saleman.id
        LEFT JOIN department department ON saleman.department_id = department.id
        WHERE
        telephone_verify IN ( 0, 1, 2, 4, 5, 6, 7, 12 )
        ) tab
        WHERE
        CASE

        WHEN tab.telephone_verify = 0 THEN
        CASE

        WHEN (
        SELECT
        count( 1 )
        FROM
        loan_reject_log rej
        WHERE
        rej.reject_origin_task = 'usertask_telephone_verify'
        AND rej.order_id = tab.order_id
        AND rej.gmt_create BETWEEN tab.ct
        AND tab.mt
        ) = 0 THEN
        FALSE ELSE TRUE
        END ELSE TRUE
        END
        AND
        CASE

        WHEN telephone_verify IN ( 2, 4, 5, 6, 7 ) THEN
        TRUE ELSE
        CASE

        WHEN tab.op_time IS NULL THEN
        TRUE ELSE tab.op_time between #{startDate} and #{endDate}
        END
        END
        <if test="actionList != null and actionList.size() > 0">
            and
            action in
            <foreach item="item" index="index" collection="actionList" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="partnerList != null and partnerList.size() > 0">
            and
            partner_id in
            <foreach item="item" index="index" collection="partnerList" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="bankList != null and bankList.size() > 0">
            and
            bank in
            <foreach item="item" index="index" collection="bankList" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        order by op_time asc
    </select>
    <!--=======================================导出 EXCEL 银行征信查询=========================================-->
    <select id="exportBankCreditQuerys" parameterType="com.yunche.loan.domain.param.ExportBankCreditQueryVerifyParam"  resultType="com.yunche.loan.domain.vo.ExportBankCreditQueryVO">
        SELECT
        principal_area.area_name,
        -- 客户类型: 1-主贷人;2-共贷人;3-担保人;4-紧急联系人;
        CASE
        WHEN customer.cust_type = 1 THEN
        '主贷人'
        WHEN customer.cust_type = 2 THEN
        '共贷人'
        WHEN customer.cust_type = 3 THEN
        '担保人'
        WHEN customer.cust_type = 4 THEN
        '紧急联系人'
        ELSE
        NULL
        END AS cust_type,
        customer. NAME AS customer_name,
        customer.id_card AS customer_id_card,
        customer.mobile AS customer_mobile,
        principal_base.bank,
        principal_partner. NAME AS partner_name,
        employee. NAME AS salesman_name,
        principal. NAME AS principal_name,
        -- 与主贷人关系：0-本人;1-配偶;2-父母;3-子女;4-兄弟姐妹;5-亲戚;6-朋友;7-同学;8-同事;9-其它;
        CASE
        WHEN customer.id = customer.principal_cust_id THEN
        '本人'
        WHEN customer.cust_relation = 0 THEN
        '本人'
        WHEN customer.cust_relation = 1 THEN
        '配偶'
        WHEN customer.cust_relation = 2 THEN
        '父母'
        WHEN customer.cust_relation = 3 THEN
        '子女'
        WHEN customer.cust_relation = 4 THEN
        '兄弟姐妹'
        WHEN customer.cust_relation = 5 THEN
        '亲戚'
        WHEN customer.cust_relation = 6 THEN
        '朋友'
        WHEN customer.cust_relation = 7 THEN
        '同学'
        WHEN customer.cust_relation = 8 THEN
        '同事'
        WHEN customer.cust_relation = 9 THEN
        '其他'
        ELSE
        NULL
        END AS cust_relation,
        -- 征信结果: 0-不通过;1-通过;2-关注;
        CASE
        WHEN credit_info.result = 0 THEN
        '不通过'
        WHEN credit_info.result = 1 THEN
        '通过'
        WHEN credit_info.result = 2 THEN
        '关注'
        WHEN credit_info.result = 3 THEN
        '银行退回'
        ELSE
        NULL
        END AS credit_result,
        CASE
        WHEN customer.guarantee_type = 1 THEN
        '银行担保'
        WHEN customer.guarantee_type = 2 THEN
        '内部担保'
        ELSE
        NULL
        END  AS guaranteeType,
        (
        SELECT
        create_time
        FROM
        loan_process_log
        WHERE
        task_definition_key = 'usertask_credit_apply'
        AND order_id = principal_orders.id
        ORDER BY
        create_time
        LIMIT 1
        ) AS credit_apply_time,
        credit_info.gmt_modify AS credit_query_time,
        (
        SELECT
        user_name
        FROM
        loan_process_log
        WHERE
        task_definition_key = 'usertask_bank_credit_record'
        AND order_id = principal_orders.id
        ORDER BY
        create_time
        LIMIT 1
        ) AS gmt_user
        FROM
        loan_customer customer
        LEFT JOIN loan_credit_info credit_info ON credit_info.customer_id = customer.id
        LEFT JOIN loan_customer principal ON customer.principal_cust_id = principal.id
        LEFT JOIN loan_order principal_orders ON principal_orders.loan_customer_id = principal.id
        LEFT JOIN loan_base_info principal_base ON principal_orders.loan_base_info_id = principal_base.id
        LEFT JOIN partner principal_partner ON principal_partner.id = principal_base.partner_id
        LEFT JOIN base_area principal_area ON principal_area.area_id = principal_base.area_id
        LEFT JOIN employee employee ON employee.id = principal_base.salesman_id
        LEFT JOIN loan_process ON principal_orders.id = loan_process.order_id

        <where>
            and (credit_info.type = 1 OR credit_info.type is NULL) AND loan_process.bank_credit_record IN (1,2)
            <if test="startDate !=null and endDate !=null">
                and credit_info.gmt_modify between #{startDate} and #{endDate}
            </if>

            <if test="partnerList != null and partnerList.size() > 0">
                and
                principal_base.partner_id in
                <foreach item="item" index="index" collection="partnerList" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="bankList != null and bankList.size() > 0">
                and
                principal_base.bank in
                <foreach item="item" index="index" collection="bankList" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            AND customer.cust_type  in  (1,2,3) and customer.status = 0
        </where>
        <if test="startCreditGmtCreate != null and endCreditGmtCreate != null">
            having(
            TO_DAYS(credit_apply_time) &gt;= TO_DAYS(#{startCreditGmtCreate})
            AND TO_DAYS(credit_apply_time) &lt;= TO_DAYS(#{endCreditGmtCreate})
            )
        </if>
        order by credit_info.gmt_modify desc
    </select>


    <!--=======================================导出 EXCEL 社会征信查询=========================================-->
    <select id="exportSocialCreditQuerys" parameterType="com.yunche.loan.domain.param.ExportSocialCreditQueryVerifyParam"  resultType="com.yunche.loan.domain.vo.ExportSocialCreditQueryVO" >
        SELECT
        principal_area.area_name,
        -- 客户类型: 1-主贷人;2-共贷人;3-担保人;4-紧急联系人;
        CASE
        WHEN customer.cust_type = 1 THEN
        '主贷人'
        WHEN customer.cust_type = 2 THEN
        '共贷人'
        WHEN customer.cust_type = 3 THEN
        '担保人'
        WHEN customer.cust_type = 4 THEN
        '紧急联系人'
        ELSE
        NULL
        END AS cust_type,
        customer. NAME AS customer_name,
        customer.id_card AS customer_id_card,
        customer.mobile AS customer_mobile,
        principal_base.bank,
        principal_partner. NAME AS partner_name,
        employee. NAME AS salesman_name,
        principal. NAME AS principal_name,
        -- 与主贷人关系：0-本人;1-配偶;2-父母;3-子女;4-兄弟姐妹;5-亲戚;6-朋友;7-同学;8-同事;9-其它;
        CASE
        WHEN customer.id = customer.principal_cust_id THEN
        '本人'
        WHEN customer.cust_relation = 0 THEN
        '本人'
        WHEN customer.cust_relation = 1 THEN
        '配偶'
        WHEN customer.cust_relation = 2 THEN
        '父母'
        WHEN customer.cust_relation = 3 THEN
        '子女'
        WHEN customer.cust_relation = 4 THEN
        '兄弟姐妹'
        WHEN customer.cust_relation = 5 THEN
        '亲戚'
        WHEN customer.cust_relation = 6 THEN
        '朋友'
        WHEN customer.cust_relation = 7 THEN
        '同学'
        WHEN customer.cust_relation = 8 THEN
        '同事'
        WHEN customer.cust_relation = 9 THEN
        '其他'
        ELSE
        NULL
        END AS cust_relation,
        -- 征信结果: 0-不通过;1-通过;2-关注;
        CASE
        WHEN credit_info.result = 0 THEN
        '不通过'
        WHEN credit_info.result = 1 THEN
        '通过'
        WHEN credit_info.result = 2 THEN
        '关注'
        WHEN credit_info.result = 3 THEN
        '银行退回'
        ELSE
        NULL
        END AS credit_result,
        CASE
        WHEN customer.guarantee_type = 1 THEN
        '银行担保'
        WHEN customer.guarantee_type = 2 THEN
        '内部担保'
        ELSE
        NULL
        END  AS guaranteeType,
        (
        SELECT
        create_time
        FROM
        loan_process_log
        WHERE
        task_definition_key = 'usertask_credit_apply'
        AND order_id = principal_orders.id
        ORDER BY
        create_time
        LIMIT 1
        ) AS credit_apply_time,
        credit_info.gmt_modify AS credit_query_time,
        (
        SELECT
        user_name
        FROM
        loan_process_log
        WHERE
        task_definition_key = 'usertask_bank_credit_record'
        AND order_id = principal_orders.id
        ORDER BY
        create_time
        LIMIT 1
        ) AS gmt_user
        FROM
        loan_customer customer
        LEFT JOIN loan_credit_info credit_info ON credit_info.customer_id = customer.id
        LEFT JOIN loan_customer principal ON customer.principal_cust_id = principal.id
        LEFT JOIN loan_order principal_orders ON principal_orders.loan_customer_id = principal.id
        LEFT JOIN loan_base_info principal_base ON principal_orders.loan_base_info_id = principal_base.id
        LEFT JOIN partner principal_partner ON principal_partner.id = principal_base.partner_id
        LEFT JOIN base_area principal_area ON principal_area.area_id = principal_base.area_id
        LEFT JOIN employee employee ON employee.id = principal_base.salesman_id
        LEFT JOIN loan_process ON principal_orders.id = loan_process.order_id
        <where>
            and (credit_info.type = 2 OR credit_info.type is NULL) AND loan_process.social_credit_record IN (1,2)
            <if test="startDate !=null and endDate !=null">
            and credit_info.gmt_modify between #{startDate} and #{endDate}
            </if>
            <if test="partnerList != null and partnerList.size() > 0">
                and
                principal_base.partner_id in
                <foreach item="item" index="index" collection="partnerList" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="bankList != null and bankList.size() > 0">
                and
                principal_base.bank in
                <foreach item="item" index="index" collection="bankList" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            AND customer.cust_type  in  (1,2,3) and customer.status = 0
        </where>
        <if test="startCreditGmtCreate != null and endCreditGmtCreate != null">
            having(
            TO_DAYS(credit_apply_time) &gt;= TO_DAYS(#{startCreditGmtCreate})
            AND TO_DAYS(credit_apply_time) &lt;= TO_DAYS(#{endCreditGmtCreate})
            )
        </if>
        order by credit_info.gmt_modify desc
    </select>
    <!--=======================================导出 EXCEL 财务垫款明细查询=========================================-->
    <select id="exportRemitDetailQuerys" parameterType="com.yunche.loan.domain.param.ExportRemitDetailQueryVerifyParam"  resultType="com.yunche.loan.domain.vo.ExportRemitDetailQueryVO" >

        SELECT
        base_area.area_name,
        customer. NAME AS customer_name,
        customer.id_card AS customer_id_card,
        customer.mobile AS customer_mobile,
        loaninfo.bank,
        partner. NAME AS partner_name,
        employee. NAME AS salesman_name,
        case when car.car_type = 0 then '新车'
             when car.car_type = 1 then '二手车'
             else '其他' end as car_type,
        loan_financial_plan.car_price AS price,
        loan_financial_plan.sign_rate,
        loan_financial_plan.loan_amount,
        loan_financial_plan.down_payment_money,
        loan_financial_plan.bank_period_principal,
        remit_details.remit_amount,
        orders.gmt_create,
        (
        SELECT
        loan_process_log.create_time
        FROM
        loan_process_log
        WHERE
        order_id = orders.id
        AND task_definition_key = 'usertask_remit_review'
        ORDER BY
        create_time DESC
        LIMIT 1
        ) as submitTime,
        (
        SELECT
        loan_process_log.user_name
        FROM
        loan_process_log
        WHERE
        order_id = orders.id
        AND task_definition_key = 'usertask_remit_review'
        ORDER BY
        create_time DESC
        LIMIT 1
        ) as username
        FROM
        loan_order orders
        LEFT JOIN loan_customer customer ON orders.loan_customer_id = customer.id
        LEFT JOIN loan_base_info loaninfo ON orders.loan_base_info_id = loaninfo.id
        LEFT JOIN base_area ON loaninfo.area_id = base_area.area_id
        LEFT JOIN loan_car_info car ON orders.loan_car_info_id = car.id
        LEFT JOIN car_detail cardetail ON cardetail.id = car.car_detail_id
        LEFT JOIN loan_financial_plan ON orders.loan_financial_plan_id = loan_financial_plan.id
        LEFT JOIN remit_details ON orders.remit_details_id = remit_details.id
        LEFT JOIN loan_process process ON orders.id = process.order_id
        LEFT JOIN loan_base_info base ON orders.loan_base_info_id = base.id
        LEFT JOIN employee employee ON base.salesman_id = employee.id
        LEFT JOIN partner partner ON partner.id = base.partner_id
        where 1=1
        and process.remit_review = 1
        and
        case when #{maxGroupLevel} = 0 then false
        when #{maxGroupLevel} = 1 then
        loaninfo.salesman_id in
        (
        <choose>
            <when test="juniorIds != null and juniorIds.size() > 0">
                <foreach item="item" index="index" collection="juniorIds" separator=",">
                    #{item}
                </foreach>
            </when>
            <otherwise>
                select temp.id from (SELECT 1 as id) temp  where temp.id =2
            </otherwise>
        </choose>
        )
        else true end
        <if test="partnerList != null and partnerList.size() > 0">
            and
            base.partner_id in
            <foreach item="item" index="index" collection="partnerList" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="bankList != null and bankList.size() > 0">
            and
            base.bank in
            <foreach item="item" index="index" collection="bankList" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="startRemitAmount !=null" >
            and
            remit_details.remit_amount &gt;= #{startRemitAmount}
        </if>

        <if test="endRemitAmount !=null" >
            AND  remit_details.remit_amount &lt;= #{endRemitAmount}
        </if>

        having submitTime between #{startDate} AND CONCAT(#{endDate},' 23.59.59')
        order by submitTime desc

    </select>

    <!--=======================================导出 EXCEL 资料审核明细查询=========================================-->
    <select id="exportMaterialReviewQuerys" parameterType="com.yunche.loan.domain.param.ExportMaterialReviewQueryVerifyParam"  resultType="com.yunche.loan.domain.vo.ExportMaterialReviewDetailQueryVO" >
        SELECT
        t.*,
        CASE

        WHEN t.express_receive_date IS NOT NULL THEN
        floor(
        ( UNIX_TIMESTAMP( DATE_FORMAT( t.express_receive_date, '%Y-%m-%d' ) ) - UNIX_TIMESTAMP( DATE_FORMAT( t.remitdate, '%Y-%m-%d' ) ) ) / ( 24 * 60 * 60 )
        ) ELSE floor(
        ( UNIX_TIMESTAMP( DATE_FORMAT( now( ), '%Y-%m-%d' ) ) - UNIX_TIMESTAMP( DATE_FORMAT( t.remitdate, '%Y-%m-%d' ) ) ) / ( 24 * 60 * 60 )
        )
        END AS remitOverdueTime,
        CASE

        WHEN t.complete_material_date IS NOT NULL THEN
        floor(
        ( UNIX_TIMESTAMP( DATE_FORMAT( t.complete_material_date, '%Y-%m-%d' ) ) - UNIX_TIMESTAMP( DATE_FORMAT( t.remitdate, '%Y-%m-%d' ) ) ) / ( 24 * 60 * 60 )
        ) ELSE floor(
        ( UNIX_TIMESTAMP( DATE_FORMAT( now( ), '%Y-%m-%d' ) ) - UNIX_TIMESTAMP( DATE_FORMAT( t.remitdate, '%Y-%m-%d' ) ) ) / ( 24 * 60 * 60 )
        )
        END AS revievOverdueTime
        FROM
        (
        SELECT
        base_area.area_name,
        partner.NAME AS partner_name,
        customer.NAME AS customer_name,
        customer.id_card,
        loan_base_info.bank,
        loan_financial_plan.bank_period_principal,
        ( SELECT create_time FROM loan_process_log WHERE orders.id = loan_process_log.order_id AND loan_process_log.task_definition_key = 'usertask_remit_review' ORDER BY id DESC LIMIT 1 ) AS remitdate,
        ( SELECT loan_data_flow.express_receive_date FROM loan_data_flow WHERE orders.id = loan_data_flow.order_id AND type = 2 ) AS express_receive_date,
        material_audit.complete_material_date,
        ( SELECT create_time FROM loan_process_log WHERE orders.id = loan_process_log.order_id AND loan_process_log.task_definition_key = 'usertask_material_review' ORDER BY id DESC LIMIT 1 ) AS materialReviewSubmit,
        CASE

        WHEN loan_process.material_review = 1 THEN
        '已提交'
        WHEN loan_process.material_review = 2 THEN
        '未提交'
        WHEN loan_process.material_review = 3 THEN
        '已打回'
        ELSE '未知' END AS material_review,
        ( SELECT count( 1 ) FROM loan_info_supplement WHERE loan_info_supplement.order_id = orders.id ) AS supplementCount,
        ( SELECT GROUP_CONCAT( DATE_FORMAT( end_time, '%Y-%m-%d  ' ), content ORDER BY id DESC ) FROM loan_info_supplement WHERE loan_info_supplement.order_id = orders.id ) AS supplementContent,
        (
        SELECT
        GROUP_CONCAT( DATE_FORMAT( start_time, '%Y-%m-%d至' ), DATE_FORMAT( end_time, '%Y-%m-%d' ) ORDER BY id DESC )
        FROM
        loan_info_supplement
        WHERE
        loan_info_supplement.order_id = orders.id
        ) AS supplementTime,
        ( SELECT create_time FROM loan_process_log WHERE orders.id = loan_process_log.order_id AND task_definition_key = 'usertask_vehicle_information' ) AS carMaterialCreateTime,
        ( SELECT loan_data_flow.express_send_date FROM loan_data_flow WHERE orders.id = loan_data_flow.order_id AND type = 3 ORDER BY id DESC LIMIT 1 ) AS express_sendbank_date
        FROM
        loan_order orders
        LEFT JOIN loan_customer customer ON orders.loan_customer_id = customer.id
        LEFT JOIN loan_base_info ON orders.loan_base_info_id = loan_base_info.id
        LEFT JOIN loan_financial_plan ON orders.loan_financial_plan_id = loan_financial_plan.id
        LEFT JOIN loan_base_info base ON orders.loan_base_info_id = base.id
        LEFT JOIN partner partner ON partner.id = base.partner_id
        LEFT JOIN remit_details ON orders.remit_details_id = remit_details.id
        LEFT JOIN base_area ON loan_base_info.area_id = base_area.area_id
        LEFT JOIN loan_process ON orders.id = loan_process.order_id
        LEFT JOIN material_audit ON orders.material_audit_id = material_audit.id

        <where>
            and loan_process.material_review != 0
            <if test="partnerList != null and partnerList.size() > 0">
                and
                base.partner_id in
                <foreach item="item" index="index" collection="partnerList" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="bankList != null and bankList.size() > 0">
                and
                base.bank in
                <foreach item="item" index="index" collection="bankList" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>

        </where>
        ) t where remitdate between #{startDate} and #{endDate}
        <if test="startDate1 != null">
            AND TO_DAYS(t.express_receive_date) &lt;= TO_DAYS(#{startDate1})
        </if>
        <if test="endDate1 != null">
            AND TO_DAYS(t.express_receive_date) &lt;= TO_DAYS(#{endDate1})
        </if>
        <if test="startDate2 != null">
            AND TO_DAYS(t.materialReviewSubmit) &lt;= TO_DAYS(#{startDate2})
        </if>
        <if test="endDate2 != null">
            AND TO_DAYS(t.materialReviewSubmit) &lt;= TO_DAYS(#{endDate2})
        </if>
        order by t.express_receive_date desc
    </select>

    <!--=======================================导出 EXCEL 抵押超期=========================================-->
    <select id="exportMortgageOverdueQuerys" parameterType="com.yunche.loan.domain.param.ExportMortgageOverdueQueryVerifyParam"  resultType="com.yunche.loan.domain.vo.ExportMortgageOverdueQueryVO" >
        SELECT
        base_area.area_name,
        partner.NAME AS partner_name,
        customer.NAME AS customer_name,
        customer.id_card,
        customer.mobile AS customer_mobile,
        loanbaseinfo.bank,
        CASE

        WHEN car.car_type = 0 THEN
        '新车'
        WHEN car.car_type = 1 THEN
        '二手车' ELSE '其他'
        END AS car_type,
        vehicle_information.license_plate_number,
        cardetail.price,
        loan_financial_plan.loan_amount,
        loan_financial_plan.bank_period_principal,
        ( SELECT create_time FROM loan_process_log WHERE orders.id = loan_process_log.order_id AND loan_process_log.task_definition_key = 'usertask_remit_review' ORDER BY id DESC LIMIT 1 ) AS remitdate,
        bank_lend_record.lend_date,
        ( SELECT loan_data_flow.express_send_date FROM loan_data_flow WHERE orders.id = loan_data_flow.order_id AND type = 12 ORDER BY id DESC LIMIT 1 ) AS sendMaterialToParter_date,
        ( SELECT loan_data_flow.express_receive_date FROM loan_data_flow WHERE orders.id = loan_data_flow.order_id AND type = 12 ORDER BY id DESC LIMIT 1 ) AS ParterReceiveMaterial_date,
        CASE

        WHEN process.apply_license_plate_deposit_info = 1 THEN
        '已提交'
        WHEN process.apply_license_plate_deposit_info = 2 THEN
        '未提交'
        WHEN process.apply_license_plate_deposit_info = 3 THEN
        '已打回' ELSE '未知'
        END AS apply_license_plate_deposit_info,
        CASE

        WHEN process.apply_license_plate_deposit_info  !=1 THEN
        NULL ELSE a.apply_license_plate_deposit_date
        END AS depositTime,
        CASE

        WHEN a.apply_license_plate_deposit_date IS NULL THEN
        floor(
        ( UNIX_TIMESTAMP( DATE_FORMAT( now( ), '%Y-%m-%d' )) - UNIX_TIMESTAMP( DATE_FORMAT( lend.lend_date, '%Y-%m-%d' ) ) ) / ( 24 * 60 * 60 )
        )
        ELSE
        floor
        (
        (UNIX_TIMESTAMP( DATE_FORMAT(a.apply_license_plate_deposit_date, '%Y-%m-%d'  )) - UNIX_TIMESTAMP( DATE_FORMAT( lend.lend_date, '%Y-%m-%d' ) ) ) / ( 24 * 60 * 60 )
        )
        END AS depositOverdueTime,
        ( SELECT user_name FROM loan_process_log WHERE order_id = orders.id AND task_definition_key = 'usertask_apply_license_plate_deposit_info' ORDER BY create_time DESC LIMIT 1 ) AS submitUser
        FROM
        loan_order orders
        LEFT JOIN loan_customer customer ON orders.loan_customer_id = customer.id
        LEFT JOIN bank_lend_record lend ON lend.id = orders.bank_lend_record_id
        LEFT JOIN loan_base_info loanbaseinfo ON orders.loan_base_info_id = loanbaseinfo.id
        LEFT JOIN base_area ON loanbaseinfo.area_id = base_area.area_id
        LEFT JOIN loan_car_info car ON orders.loan_car_info_id = car.id
        LEFT JOIN car_detail cardetail ON cardetail.id = car.car_detail_id
        LEFT JOIN vehicle_information ON vehicle_information.id = orders.vehicle_information_id
        LEFT JOIN loan_financial_plan ON orders.loan_financial_plan_id = loan_financial_plan.id
        LEFT JOIN remit_details ON orders.remit_details_id = remit_details.id
        LEFT JOIN bank_lend_record ON orders.bank_lend_record_id = bank_lend_record.id
        LEFT JOIN loan_process process ON orders.id = process.order_id
        LEFT JOIN loan_base_info base ON orders.loan_base_info_id = base.id
        LEFT JOIN employee employee ON base.salesman_id = employee.id
        LEFT JOIN partner partner ON partner.id = base.partner_id
        LEFT JOIN apply_license_plate_deposit_info a ON a.id = orders.apply_license_plate_deposit_info_id

        <where>
            and process.apply_license_plate_deposit_info != 0  and bank_lend_record.lend_date between #{startDate} and #{endDate}
            <if test="partnerList != null and partnerList.size() > 0">
                and
                base.partner_id in
                <foreach item="item" index="index" collection="partnerList" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="bankList != null and bankList.size() > 0">
                and
                base.bank in
                <foreach item="item" index="index" collection="bankList" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
        order by bank_lend_record.lend_date desc
    </select>




    <select id="exportOrders" resultType="com.yunche.loan.domain.vo.ExportOrdersVO" parameterType="com.yunche.loan.domain.param.ExportOrdersParam">
            select
             orders.id 																		    as order_id,
             customer.name 																	    as customer_name,
             customer.id_card 																    as customer_id_card,
             customer.mobile 																    as customer_mobile,
             saleman.name 																	    as saleman,
             partner.name 																	    as partner_name,
             plan.car_price 																	as car_price,
             plan.bank 																		    as plan_bank,
             plan.appraisal 																	as plan_appraisal,
             plan.loan_amount 																    as plan_loan_amount,
             plan.bank_period_principal 														as plan_bank_period_principal,
             remit.remit_amount 																as remit_amount,
             plan.loan_time 																	as plan_loan_time,
             useGetCarName(car.car_detail_id)  												    as car_name,
             case when car.car_type = 0 then '新车'
                  when car.car_type = 1 then '二手车'
             else '其他' end 																    as car_type,
             vehicle.license_plate_number 														as vehicle_license_plate_number,
             vehicle.engine_number 																as vehicle_engine_number,
             vehicle.vehicle_identification_number 												as vehicle_identification_number,
             vehicle.register_date																as vehicle_register_date,
             vehicle.color 																		as vehicle_color,
             vehicle.displacement																as vehicle_displacement,
             TIMESTAMPDIFF(MONTH,now(),vehicle.register_date) 							        as vehicle_use_year,
             current.usertask_credit_apply_create_time											as usertask_credit_apply_create_time,
             current.usertask_bank_credit_record_create_time								    as usertask_bank_credit_record_create_time,
             current.usertask_social_credit_record_create_time							        as usertask_social_credit_record_create_time,
             current.usertask_loan_apply_create_time											as usertask_loan_apply_create_time,
             current.usertask_visit_verify_create_time											as usertask_visit_verify_create_time,
             current.usertask_telephone_verify_create_time									    as usertask_telephone_verify_create_time,
             current.usertask_vehicle_information_create_time								    as usertask_vehicle_information_create_time,
             current.usertask_material_review_create_time										as usertask_material_review_create_time,
             current.usertask_material_print_review_create_time							        as usertask_material_print_review_create_time,
             current.usertask_install_gps_create_time											as usertask_install_gps_create_time,
             current.usertask_apply_license_plate_deposit_info_create_time	                    as usertask_apply_license_plate_deposit_info_create_time,
             current.usertask_car_insurance_create_time											as usertask_car_insurance_create_time,
             current.usertask_business_pay_create_time											as usertask_business_pay_create_time,
             current.usertask_business_review_create_time										as usertask_business_review_create_time,
             current.usertask_loan_review_create_time											as usertask_loan_review_create_time,
             current.usertask_remit_review_create_time											as usertask_remit_review_create_time,
             current.usertask_material_manage_create_time										as usertask_material_manage_create_time,
             lend.lend_date																		as usertask_bank_lend_record_create_time,
             send.express_send_date																as usertask_bank_card_send_create_time


        FROM
        loan_order orders
        LEFT JOIN loan_process process ON orders.id = process.order_id
        LEFT JOIN loan_base_info baseinfo ON orders.loan_base_info_id = baseinfo.id
        LEFT JOIN loan_customer customer ON customer.id = orders.loan_customer_id
        LEFT JOIN loan_financial_plan plan ON plan.id = orders.loan_financial_plan_id
        LEFT JOIN remit_details remit on orders.remit_details_id = remit.id
        LEFT JOIN loan_car_info car on car.id = orders.loan_car_info_id
        LEFT JOIN vehicle_information vehicle on vehicle.id = orders.vehicle_information_id
        LEFT JOIN current_node_manager current on orders.id = current.order_id
        LEFT JOIN bank_lend_record lend on lend.id = orders.bank_lend_record_id
        LEFT JOIN loan_bank_card_send send on send.order_id = orders.id
        LEFT JOIN partner partner ON baseinfo.partner_id = partner.id
        LEFT JOIN employee saleman ON baseinfo.salesman_id = saleman.id
        LEFT JOIN department department ON saleman.department_id = department.id
        where 1=1
            <if test="partnerList != null and partnerList.size() > 0">
                and
                baseinfo.partner_id in
                <foreach item="item" index="index" collection="partnerList" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="bankList != null and bankList.size() > 0">
                and
                baseinfo.bank in
                <foreach item="item" index="index" collection="bankList" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="car_type!=null and car_type!=''">
                and car.car_type = #{car_type}
            </if>
        having 1=1
        <if test="order_id!=null and order_id!=''">
            AND  order_id LIKE CONCAT('%', #{order_id} ,'%')
        </if>
        <if test="customer_name!=null and customer_name!=''">
            AND  customer_name LIKE CONCAT('%', #{customer_name} ,'%')
        </if>
        <if test="customer_id_card!=null and customer_id_card!=''">
            AND  customer_id_card LIKE CONCAT('%', #{customer_id_card} ,'%')
        </if>
        <if test="customer_mobile!=null and customer_mobile!=''">
            AND  customer_mobile LIKE CONCAT('%', #{customer_mobile} ,'%')
        </if>
        <if test="saleman!=null and saleman!=''">
            AND  saleman LIKE CONCAT('%', #{saleman} ,'%')
        </if>
        <if test="partner_name!=null and partner_name!=''">
            AND  partner_name LIKE CONCAT('%', #{partner_name} ,'%')
        </if>
        <if test="car_price_start!=null and car_price_start!='' and car_price_end!=null and car_price_end!=''">
            AND car_price &gt;= #{car_price_start} and car_price &lt;= #{car_price_end}
        </if>
        <if test="plan_bank!=null and plan_bank!=''">
            AND  plan_bank LIKE CONCAT('%', #{plan_bank} ,'%')
        </if>
        <if test="plan_appraisal_start!=null and plan_appraisal_start!='' and plan_appraisal_end!=null and plan_appraisal_end!=''">
            AND plan_appraisal &gt;= #{plan_appraisal_start} and plan_appraisal &lt;= #{plan_appraisal_end}
        </if>
        <if test="plan_loan_amount_start!=null and plan_loan_amount_start!='' and plan_loan_amount_end!=null and plan_loan_amount_end!=''">
            AND plan_loan_amount &gt;= #{plan_loan_amount_start} and plan_loan_amount &lt;= #{plan_loan_amount_end}
        </if>
        <if test="plan_bank_period_principal_start!=null and plan_bank_period_principal_start!='' and plan_bank_period_principal_end!=null and plan_bank_period_principal_end!='' ">
            AND plan_bank_period_principal &gt;= #{plan_bank_period_principal_start} and plan_bank_period_principal &lt;= #{plan_bank_period_principal_end}
        </if>
        <if test="remit_amount_start!=null and remit_amount_start!='' and remit_amount_end!=null and remit_amount_end!=''">
            AND remit_amount &gt;= #{remit_amount_start} and remit_amount &lt;= #{remit_amount_end}
        </if>
        <if test="plan_loan_time_start!=null and plan_loan_time_start!='' and plan_loan_time_end!=null and plan_loan_time_end!=''">
            AND plan_loan_time &gt;= #{plan_loan_time_start} and plan_loan_time &lt;= #{plan_loan_time_end}
        </if>
        <if test="car_name!=null and car_name!=''">
            AND  car_name LIKE CONCAT('%', #{car_name} ,'%')
        </if>
        <if test="vehicle_license_plate_number!=null and vehicle_license_plate_number!=''">
            AND  vehicle_license_plate_number LIKE CONCAT('%', #{vehicle_license_plate_number} ,'%')
        </if>
        <if test="vehicle_engine_number!=null and vehicle_engine_number!=''">
            AND  vehicle_engine_number LIKE CONCAT('%', #{vehicle_engine_number} ,'%')
        </if>
        <if test="vehicle_identification_number!=null and vehicle_identification_number!=''">
            AND  vehicle_identification_number LIKE CONCAT('%', #{vehicle_identification_number} ,'%')
        </if>
        <if test="vehicle_register_date_start!=null and vehicle_register_date_start!='' and vehicle_register_date_end!=null and vehicle_register_date_end!=''">
            AND TO_DAYS(vehicle_register_date) &gt;= TO_DAYS(#{vehicle_register_date_start}) and TO_DAYS(vehicle_register_date) &lt;= TO_DAYS(#{vehicle_register_date_end})
        </if>
        <if test="vehicle_color!=null and vehicle_color!=''">
            AND  vehicle_color LIKE CONCAT('%', #{vehicle_color} ,'%')
        </if>
        <if test="vehicle_displacement!=null and vehicle_displacement!=''">
            AND  vehicle_displacement LIKE CONCAT('%', #{vehicle_displacement} ,'%')
        </if>
        <if test="vehicle_use_year_start!=null and vehicle_use_year_start!='' and vehicle_use_year_end!=null and vehicle_use_year_end!=''">
            AND vehicle_use_year &gt;= #{vehicle_use_year_start} and vehicle_use_year &lt;= #{vehicle_use_year_end}
        </if>
        <if test="usertask_credit_apply_create_time_start!=null and usertask_credit_apply_create_time_start!='' and usertask_credit_apply_create_time_end!=null and usertask_credit_apply_create_time_end!='' ">
            AND TO_DAYS(usertask_credit_apply_create_time) &gt;= TO_DAYS(#{usertask_credit_apply_create_time_start})
            AND TO_DAYS(usertask_credit_apply_create_time) &lt;= TO_DAYS(#{usertask_credit_apply_create_time_end})
        </if>
        <if test="usertask_bank_credit_record_create_time_start!=null and usertask_bank_credit_record_create_time_start!='' and usertask_bank_credit_record_create_time_end!=null and usertask_bank_credit_record_create_time_end!=''">
            AND TO_DAYS(usertask_bank_credit_record_create_time) &gt;= TO_DAYS(#{usertask_bank_credit_record_create_time_start})
            AND TO_DAYS(usertask_bank_credit_record_create_time) &lt;= TO_DAYS(#{usertask_bank_credit_record_create_time_end})
        </if>
        <if test="usertask_social_credit_record_create_time_start!=null and usertask_social_credit_record_create_time_start!='' and usertask_social_credit_record_create_time_end!=null and usertask_social_credit_record_create_time_end!=''">
            AND TO_DAYS(usertask_social_credit_record_create_time) &gt;= TO_DAYS(#{usertask_social_credit_record_create_time_start})
            AND TO_DAYS(usertask_social_credit_record_create_time) &lt;= TO_DAYS(#{usertask_social_credit_record_create_time_end})
        </if>
        <if test="usertask_loan_apply_create_time_start!=null and usertask_loan_apply_create_time_start!='' and usertask_loan_apply_create_time_end!=null and usertask_loan_apply_create_time_end!=''">
            AND TO_DAYS(usertask_loan_apply_create_time) &gt;= TO_DAYS(#{usertask_loan_apply_create_time_start})
            AND TO_DAYS(usertask_loan_apply_create_time) &lt;= TO_DAYS(#{usertask_loan_apply_create_time_end})
        </if>
        <if test="usertask_visit_verify_create_time_start!=null and usertask_visit_verify_create_time_start!='' and usertask_visit_verify_create_time_end!=null and usertask_visit_verify_create_time_end!=''">
            AND TO_DAYS(usertask_visit_verify_create_time) &gt;= TO_DAYS(#{usertask_visit_verify_create_time_start})
            AND TO_DAYS(usertask_visit_verify_create_time) &lt;= TO_DAYS(#{usertask_visit_verify_create_time_end})
        </if>
        <if test="usertask_telephone_verify_create_time_start!=null and usertask_telephone_verify_create_time_start!='' and usertask_telephone_verify_create_time_end!=null and usertask_telephone_verify_create_time_end!=''">
            AND TO_DAYS(usertask_telephone_verify_create_time) &gt;= TO_DAYS(#{usertask_telephone_verify_create_time_start})
            AND TO_DAYS(usertask_telephone_verify_create_time) &lt;= TO_DAYS(#{usertask_telephone_verify_create_time_end})
        </if>
        <if test="usertask_vehicle_information_create_time_start!=null and usertask_vehicle_information_create_time_start!='' and usertask_vehicle_information_create_time_end!=null and usertask_vehicle_information_create_time_end!=''">
            AND TO_DAYS(usertask_vehicle_information_create_time) &gt;= TO_DAYS(#{usertask_vehicle_information_create_time_start})
            AND TO_DAYS(usertask_vehicle_information_create_time) &lt;= TO_DAYS(#{usertask_vehicle_information_create_time_end})
        </if>
        <if test="usertask_material_review_create_time_start!=null and usertask_material_review_create_time_start!='' and usertask_material_review_create_time_end!=null and usertask_material_review_create_time_end!=''">
            AND TO_DAYS(usertask_material_review_create_time) &gt;= TO_DAYS(#{usertask_material_review_create_time_start})
            AND TO_DAYS(usertask_material_review_create_time) &lt;= TO_DAYS(#{usertask_material_review_create_time_end})
        </if>
        <if test="usertask_material_print_review_create_time_start!=null and usertask_material_print_review_create_time_start!='' and usertask_material_print_review_create_time_end!=null and usertask_material_print_review_create_time_end!=''">
            AND TO_DAYS(usertask_material_print_review_create_time) &gt;= TO_DAYS(#{usertask_material_print_review_create_time_start})
            AND TO_DAYS(usertask_material_print_review_create_time) &lt;= TO_DAYS(#{usertask_material_print_review_create_time_end})
        </if>
        <if test="usertask_install_gps_create_time_start!=null and usertask_install_gps_create_time_start!='' and usertask_install_gps_create_time_end!=null and usertask_install_gps_create_time_end!=''">
            AND TO_DAYS(usertask_install_gps_create_time) &gt;= TO_DAYS(#{usertask_install_gps_create_time_start})
            AND TO_DAYS(usertask_install_gps_create_time) &lt;= TO_DAYS(#{usertask_install_gps_create_time_end})
        </if>
        <if test="usertask_apply_license_plate_deposit_info_create_time_start!=null and usertask_apply_license_plate_deposit_info_create_time_start!='' and usertask_apply_license_plate_deposit_info_create_time_end!=null and usertask_apply_license_plate_deposit_info_create_time_end!=''">
            AND TO_DAYS(usertask_apply_license_plate_deposit_info_create_time) &gt;= TO_DAYS(#{usertask_apply_license_plate_deposit_info_create_time_start})
            AND TO_DAYS(usertask_apply_license_plate_deposit_info_create_time) &lt;= TO_DAYS(#{usertask_apply_license_plate_deposit_info_create_time_end})
        </if>
        <if test="usertask_car_insurance_create_time_start!=null and usertask_car_insurance_create_time_start!='' and usertask_car_insurance_create_time_end!=null and usertask_car_insurance_create_time_end!=''">
            AND TO_DAYS(usertask_car_insurance_create_time) &gt;= TO_DAYS(#{usertask_car_insurance_create_time_start})
            AND TO_DAYS(usertask_car_insurance_create_time) &lt;= TO_DAYS(#{usertask_car_insurance_create_time_end})
        </if>
        <if test="usertask_business_pay_create_time_start!=null and usertask_business_pay_create_time_start!='' and usertask_business_pay_create_time_end!=null and usertask_business_pay_create_time_end!=''">
            AND TO_DAYS(usertask_business_pay_create_time) &gt;= TO_DAYS(#{usertask_business_pay_create_time_start})
            AND TO_DAYS(usertask_business_pay_create_time) &lt;= TO_DAYS(#{usertask_business_pay_create_time_end})
        </if>
        <if test="usertask_business_review_create_time_start!=null and usertask_business_review_create_time_start!='' and usertask_business_review_create_time_end!=null and usertask_business_review_create_time_end!=''">
            AND TO_DAYS(usertask_business_review_create_time) &gt;= TO_DAYS(#{usertask_business_review_create_time_start})
            AND TO_DAYS(usertask_business_review_create_time) &lt;= TO_DAYS(#{usertask_business_review_create_time_end})
        </if>
        <if test="usertask_loan_review_create_time_start!=null and usertask_loan_review_create_time_start!='' and usertask_loan_review_create_time_end!=null and usertask_loan_review_create_time_end!=''">
            AND TO_DAYS(usertask_loan_review_create_time) &gt;= TO_DAYS(#{usertask_loan_review_create_time_start})
            AND TO_DAYS(usertask_loan_review_create_time) &lt;= TO_DAYS(#{usertask_loan_review_create_time_end})
        </if>
        <if test="usertask_remit_review_create_time_start!=null and usertask_remit_review_create_time_start!='' and usertask_remit_review_create_time_end!=null and usertask_remit_review_create_time_end!=''">
            AND TO_DAYS(usertask_remit_review_create_time) &gt;= TO_DAYS(#{usertask_remit_review_create_time_start})
            AND TO_DAYS(usertask_remit_review_create_time) &lt;= TO_DAYS(#{usertask_remit_review_create_time_end})
        </if>
        <if test="usertask_material_manage_create_time_start!=null and usertask_material_manage_create_time_start!='' and usertask_material_manage_create_time_end!=null and usertask_material_manage_create_time_end!=''">
            AND TO_DAYS(usertask_material_manage_create_time) &gt;= TO_DAYS(#{usertask_material_manage_create_time_start})
            AND TO_DAYS(usertask_material_manage_create_time) &lt;= TO_DAYS(#{usertask_material_manage_create_time_end})
        </if>
        <if test="usertask_bank_lend_record_create_time_start!=null and usertask_bank_lend_record_create_time_start!='' and usertask_bank_lend_record_create_time_end!=null and usertask_bank_lend_record_create_time_end!=''">
            AND TO_DAYS(usertask_bank_lend_record_create_time) &gt;= TO_DAYS(#{usertask_bank_lend_record_create_time_start})
            AND TO_DAYS(usertask_bank_lend_record_create_time) &lt;= TO_DAYS(#{usertask_bank_lend_record_create_time_end})
        </if>
        <if test="usertask_bank_card_send_create_time_start!=null and usertask_bank_card_send_create_time_start!='' and usertask_bank_card_send_create_time_end!=null and usertask_bank_card_send_create_time_end!=''">
            AND TO_DAYS(usertask_bank_card_send_create_time) &gt;= TO_DAYS(#{usertask_bank_card_send_create_time_start})
            AND TO_DAYS(usertask_bank_card_send_create_time) &lt;= TO_DAYS(#{usertask_bank_card_send_create_time_end})
        </if>
    </select>
    <!--=======================================导出 EXCEL 财务垫款明细查询-财务打款单=========================================-->
    <select id="exportRemitDetailForRemitOrderQuerys" parameterType="com.yunche.loan.domain.param.ExportRemitDetailQueryVerifyParam"  resultType="com.yunche.loan.domain.vo.ExportRemitDetailQueryForRemitOrderVO" >

        SELECT
        base_area.area_name,
        customer. NAME AS customer_name,
        customer.id_card AS customer_id_card,
        customer.mobile AS customer_mobile,
        loaninfo.bank,
        partner. NAME AS partner_name,
        employee. NAME AS salesman_name,
        case when car.car_type = 0 then '新车'
        when car.car_type = 1 then '二手车'
        else '其他' end as car_type,
        loan_financial_plan.car_price AS price,
        loan_financial_plan.sign_rate,
        loan_financial_plan.loan_amount,
        loan_financial_plan.down_payment_money,
        loan_financial_plan.bank_period_principal,
        remit_details.remit_amount,

        remit_details.return_rate_amount                                                                AS remit_return_rate_amount,
        cost_details.service_fee,
        cost_details.performance_fee,
        cost_details.apply_license_plate_deposit_fee,
        cost_details.install_gps_fee,
        cost_details.risk_fee,
        cost_details.fair_assess_fee,
        cost_details.apply_license_plate_out_province_fee,
        cost_details.based_margin_fee,
        cost_details.rebate_not_deducted,
        cost_details.extra_fee,
        cost_details.other_fee,


        orders.gmt_create,
        (
        SELECT
        loan_process_log.create_time
        FROM
        loan_process_log
        WHERE
        order_id = orders.id
        AND task_definition_key = 'usertask_remit_review'
        ORDER BY
        create_time DESC
        LIMIT 1
        ) as submitTime,
        (
        SELECT
        loan_process_log.create_time
        FROM
        loan_process_log
        WHERE
        order_id = orders.id
        AND task_definition_key = 'usertask_refund_apply_review'
        ORDER BY
        create_time DESC
        LIMIT 1
        ) as refundTime,
        (
        SELECT
        loan_process_log.user_name
        FROM
        loan_process_log
        WHERE
        order_id = orders.id
        AND task_definition_key = 'usertask_remit_review'
        ORDER BY
        create_time DESC
        LIMIT 1
        ) as username
        FROM
        loan_order orders
        LEFT JOIN loan_customer customer ON orders.loan_customer_id = customer.id
        LEFT JOIN loan_base_info loaninfo ON orders.loan_base_info_id = loaninfo.id
        LEFT JOIN base_area ON loaninfo.area_id = base_area.area_id
        LEFT JOIN loan_car_info car ON orders.loan_car_info_id = car.id
        LEFT JOIN car_detail cardetail ON cardetail.id = car.car_detail_id
        LEFT JOIN loan_financial_plan ON orders.loan_financial_plan_id = loan_financial_plan.id
        LEFT JOIN remit_details ON orders.remit_details_id = remit_details.id
        LEFT JOIN loan_process process ON orders.id = process.order_id
        LEFT JOIN loan_base_info base ON orders.loan_base_info_id = base.id
        LEFT JOIN employee employee ON base.salesman_id = employee.id
        LEFT JOIN partner partner ON partner.id = base.partner_id
        LEFT JOIN cost_details ON orders.cost_details_id = cost_details.id

        where 1=1
        and process.remit_review IN (1,21)
        and
        case when #{maxGroupLevel} = 0 then false
        when #{maxGroupLevel} = 1 then
        loaninfo.salesman_id in
        (
        <choose>
            <when test="juniorIds != null and juniorIds.size() > 0">
                <foreach item="item" index="index" collection="juniorIds" separator=",">
                    #{item}
                </foreach>
            </when>
            <otherwise>
                select temp.id from (SELECT 1 as id) temp  where temp.id =2
            </otherwise>
        </choose>
        )
        else true end
        <if test="partnerList != null and partnerList.size() > 0">
            and
            base.partner_id in
            <foreach item="item" index="index" collection="partnerList" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="bankList != null and bankList.size() > 0">
            and
            base.bank in
            <foreach item="item" index="index" collection="bankList" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="startRemitAmount !=null" >
            and
            remit_details.remit_amount &gt;= #{startRemitAmount}
        </if>

        <if test="endRemitAmount !=null" >
            AND  remit_details.remit_amount &lt;= #{endRemitAmount}
        </if>

        having submitTime between #{startDate} and #{endDate}
        order by submitTime desc

    </select>

    <select id="exportApplyLoanPush" parameterType="com.yunche.loan.domain.param.ExportApplyLoanPushParam"  resultType="com.yunche.loan.domain.vo.ExportApplyLoanPushVO">
    select
        @row:=@row+1    AS rowId,
        customer.name     AS customerName,
        customer.id_card  AS customerIdCard,
        car.car_detail_name  AS carDetailName,
        financial.car_price  AS carPrice,
        financial.down_payment_money   AS downPaymentMoney,
        remit.remit_amount             AS remitAmount,
        ''                             AS loanTime,
        ''                             AS interestRate,
        ''                             AS loanForm,
        base.bank                      AS bank
        from
        (select * from loan_process where xxxx=1) process
        LEFT JOIN (select @row:=0) r  on 1=1
        LEFT JOIN loan_order  loan ON process.order_id = loan.id
        LEFT JOIN loan_base_info base ON loan.loan_base_info_id=base.id
        LEFT JOIN third_party_fund_business fund ON loan.id=fund.order_id
        LEFT JOIN loan_customer customer ON loan.loan_customer_id = customer.id
        LEFT JOIN loan_financial_plan financial ON financial.id = loan.loan_financial_plan_id
        LEFT JOIN remit_details remit  ON loan.remit_details_id =remit.id
        LEFT JOIN loan_car_info car ON loan.loan_car_info_id=car.id
        where  1=1
        <if test="name !=null">
            AND customer.name=#{name}
        </if>
        <if test="startLendDate !=null">
            AND fund.lend_date &gt;= #{startLendDate}
        </if>
        <if test="endLendDate !=null">
            AND fund.lend_date &lt;= #{endLendDate}
        </if>
    </select>

    <select id="exportJinTouHangRepayInfo" parameterType="com.yunche.loan.domain.param.ExportApplyLoanPushParam"  resultType="com.yunche.loan.domain.vo.JinTouHangRepayInfoVO">
        select
            fund.lend_date            				AS lendDate,
            fund.repay_date           				AS repayDate,
            remit.remit_amount        				AS remitAmount,
            customer.`name`           				AS name,
            customer.id_card          				AS idCard,
            financial.bank_period_principal   AS  bankPeriodPrincipal,
            fund.repay_type                   AS repayType,
            fund.repay_remark                 AS repayRemark
        from
            (select * from loan_process where xxxx=1) process
            LEFT JOIN loan_order  loan ON process.order_id = loan.id
            LEFT JOIN loan_base_info base ON loan.loan_base_info_id=base.id
            LEFT JOIN third_party_fund_business fund ON loan.id=fund.order_id
            LEFT JOIN loan_customer customer ON loan.loan_customer_id = customer.id
            LEFT JOIN loan_financial_plan financial ON financial.id = loan.loan_financial_plan_id
            LEFT JOIN remit_details remit  ON loan.remit_details_id =remit.id
        where  1=1
        <if test="startRepayDate !=null">
            fund.repay_date &gt;= #{startRepayDate}
        </if>
        <if test="endRepayDate !=null">
            fund.repay_date &gt;= #{endRepayDate}
        </if>
    </select>

    <select id="JinTouHangInterestRegister" parameterType="com.yunche.loan.domain.param.ExportApplyLoanPushParam"  resultType="com.yunche.loan.domain.vo.JinTouHangInterestRegisterVO">
        select
            fund.lend_date            				AS lendDate,
            fund.repay_date           				AS repayDate,
            remit.remit_amount        				AS remitAmount,
            customer.`name`           				AS name,
            customer.id_card          				AS idCard,
            financial.bank_period_principal   AS  bankPeriodPrincipal
        from
            (select * from loan_process where xxxx=2) process
            LEFT JOIN loan_order  loan ON process.order_id = loan.id
            LEFT JOIN loan_base_info base ON loan.loan_base_info_id=base.id
            LEFT JOIN third_party_fund_business fund ON loan.id=fund.order_id
            LEFT JOIN loan_customer customer ON loan.loan_customer_id = customer.id
            LEFT JOIN loan_financial_plan financial ON financial.id = loan.loan_financial_plan_id
            LEFT JOIN remit_details remit  ON loan.remit_details_id =remit.id
        where  1=1
        <if test="startRepayDate !=null">
            fund.repay_date &gt;= #{startRepayDate}
        </if>
        <if test="endRepayDate !=null">
            fund.repay_date &gt;= #{endRepayDate}
        </if>
        <if test="name !=null">
            customer.name =#{name}
        </if>
        <if test="startLendDate !=null">
            AND fund.lend_date &gt;= #{startLendDate}
        </if>
        <if test="endLendDate !=null">
            AND fund.lend_date &lt;= #{endLendDate}
        </if>
    </select>

</mapper>
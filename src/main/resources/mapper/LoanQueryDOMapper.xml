<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yunche.loan.mapper.LoanQueryDOMapper" >


    <!--提车资料-->
    <select id="selectVehicleInformation" resultType="com.yunche.loan.domain.vo.VehicleInformationVO"  parameterType="java.lang.Long">
        select

            o.id                              AS order_id,
            c.id                              AS customer_id,
            c.name                            AS cname,
            c.id_card                         AS id_card,
            e.name                            AS ename,
            p.name                            AS pname,
            useGetCarName(i.car_detail_id)    AS car_name,
            f.car_price                       AS car_price,
            d.price                           AS assess_price,
            m.production_type                 AS production_type,
            i.car_type                        AS car_type,
            v.license_plate_type              AS license_plate_type,
            v.color                           AS color,
            v.qualified_certificate_number    AS qualified_certificate_number,
            v.register_date                   AS register_date,
            v.vehicle_identification_number   AS vehicle_identification_number,
            v.displacement                    AS displacement,
            v.license_plate_number            AS license_plate_number,
            v.apply_license_plate_date        AS apply_license_plate_date,
            v.apply_license_plate_area        AS apply_license_plate_area,
            v.transfer_ownership_date         AS transfer_ownership_date,
            v.now_driving_license_owner       AS now_driving_license_owner,
            v.old_driving_license_owner       AS old_driving_license_owner,
            v.engine_number                   AS engine_number,
            v.registration_certificate_number AS registration_certificate_number,
            v.invoice_car_dealer              AS invoice_car_dealer,
            v.purchase_car_invoice_num        AS purchase_car_invoice_num,
            v.purchase_car_invoice_price      AS purchase_car_invoice_price,
            v.invoice_down_payment            AS invoice_down_payment,
            v.purchase_car_invoice_date       AS purchase_car_invoice_date,
            v.retrieve_key                    AS retrieve_key


            from (select * from loan_order where id = #{orderId,jdbcType=BIGINT}) o

            left join loan_customer c on o.loan_customer_id = c.id

            left join vehicle_information v on o.vehicle_information_id = v.id

            left join loan_base_info b on o.loan_base_info_id = b.id

            left join partner p on b.partner_id = p.id

            left join employee e on b.salesman_id = e.id

            left join loan_car_info i on o.loan_car_info_id  = i.id

            left join loan_financial_plan f on o.loan_financial_plan_id = f.id

            left join car_detail d on i.car_detail_id = d.id

            left join car_model m on model_id = m.id
    </select>
  <!--上牌抵押-->
  <select id="selectApplyLicensePlateDepositInfo" resultType="com.yunche.loan.domain.vo.ApplyLicensePlateDepositInfoVO" parameterType="java.lang.Long" >

    select
             o.id                               AS order_id,
             c.id                               AS customer_id,
             c.name                             AS cname,
             1                                  AS card_type,
             c.id_card                          AS id_card,
             e.name                             AS ename,
             p.name                             AS pname,
             h.old_driving_license_owner        AS old_driving_license_owner,
             i.car_type                         AS car_type,
             b.bank                             AS bank,
             h.license_plate_number             AS license_plate_number,
             h.transfer_ownership_date          AS transfer_ownership_date,
             h.apply_license_plate_area         AS apply_license_plate_area,
             h.apply_license_plate_date         AS apply_license_plate_date,
             a.apply_license_plate_deposit_date AS apply_license_plate_deposit_date,
             h.registration_certificate_number  AS registration_certificate_number

    from (select * from loan_order where id = #{orderId,jdbcType=BIGINT}) o

    left join loan_customer c on o.loan_customer_id= c.id

    left join loan_base_info b on o.loan_base_info_id = b.id

    left join loan_car_info i on o.loan_car_info_id = i.id

    left join vehicle_information h on o.vehicle_information_id = h.id

    left join apply_license_plate_deposit_info a on o.apply_license_plate_deposit_info_id = a.id

    left join partner p on b.partner_id = p.id

    left join employee e on b.salesman_id = e.id

  </select>

    <!--======================================通用=========================================================-->
    <!--通用info-->
  <select id="selectUniversalInfo" resultType="com.yunche.loan.domain.vo.UniversalInfoVO" parameterType="java.lang.Long" >
    select
            main_order.id                                                                           AS order_id,
            DATE_FORMAT(material.complete_material_date,'%Y-%m-%d %H:%i:%S')                        AS material_complete_material_date,
            DATE_FORMAT(loan.gmt_create,'%Y-%m-%d %H:%i:%S')                                        AS loan_gmt_create,
            product.category_superior                                                               AS product_category_superior,
            department.name                                                                         AS department_name,
            customer.id                                                                             AS customer_id,
            customer.id_card                                                                        AS customer_id_card,
            customer.name                                                                           AS customer_name,
            customer.address                                                                        AS customer_address,
            customer.income_certificate_company_name                                                AS customer_income_certificate_company_name,
            customer.postcode                                                                       AS customer_postcode,
            customer.company_address                                                                AS customer_company_address,
            customer.mobile                                                                         AS customer_mobile,
            customer.company_phone                                                                  AS customer_company_phone,
            partner.id                                                                              AS partner_id,
            partner.name                                                                            AS partner_name,
            useGetAreaFullName(partner.area_id)                                                     AS partner_biz_area,
            partner.risk_bear_rate                                                                  AS partner_risk_bear_rate,
            partner.pay_month                                                                       AS partner_pay_month,
            salesman.id                                                                             AS salesman_id,
            salesman.name                                                                           AS salesman_name,
            salesman.mobile                                                                         AS salesman_mobile,
            car.cooperation_dealer                                                                  AS car_cooperation_dealer,
            useGetCarName(car.car_detail_id)                                                        AS car_name,
            car.car_type                                                                            AS car_type,
            car.gps_num                                                                             AS car_gps_num,
            car.business_source                                                                     AS car_business_source,
            car.vehicle_property                                                                    AS car_vehicle_property,
            car.car_key                                                                             AS car_key,
            vehicle.color                                                                           AS vehicle_color,
            vehicle.now_driving_license_owner                                                       AS vehicle_now_driving_license_owner,
            vehicle.license_plate_type                                                              AS vehicle_license_plate_type,
            vehicle.apply_license_plate_area                                                        AS vehicle_apply_license_plate_area,
            bank_credit.gmt_create                                                                  AS bank_credit_gmt_create,
            society_credit.gmt_create                                                               AS society_credit_gmt_create,
            financial.bank                                                                          AS financial_bank,
            financial.loan_time                                                                     AS financial_loan_time,
            financial.appraisal                                                                     AS financial_appraisal,
            financial.down_payment_ratio                                                            AS financial_down_payment_ratio,
            useGetBankRate(financial.financial_product_id,financial.loan_time)
                                                                                                    AS financial_bank_rate,
            (1-financial.down_payment_ratio)                                                        AS financial_loan_ratio,
            useGetBankFee(product.formula_id,financial.loan_amount,financial.sign_rate,useGetBankRate(financial.financial_product_id,financial.loan_time),financial.loan_time)
                                                                                                    AS financial_bank_fee,
            financial.financial_product_name                                                        AS financial_product_name,
            financial.sign_rate                                                                     AS financial_sign_rate,
            financial.loan_amount                                                                   AS financial_loan_amount,
            financial.first_month_repay                                                             AS financial_first_month_repay,
            useCalculateStagingRatio(product.formula_id,financial.loan_amount,financial.sign_rate,useGetBankRate(financial.financial_product_id,financial.loan_time),financial.car_price)
                                                                                                    AS financial_bank_staging_ratio,
            financial.cash_deposit                                                                  AS financial_cash_deposit,
            financial.car_price                                                                     AS financial_car_price,
            financial.down_payment_money                                                            AS financial_down_payment_money,
            financial.bank_period_principal                                                         AS financial_bank_period_principal,
            financial.each_month_repay                                                              AS financial_each_month_repay,
            financial.loan_amount                                                                   AS financial_total_repayment_amount,
            financial.extra_fee                                                                     AS financial_extra_fee,
            remit.beneficiary_bank                                                                  AS remit_beneficiary_bank,
            remit.beneficiary_account                                                               AS remit_beneficiary_account,
            remit.beneficiary_account_number                                                        AS remit_beneficiary_account_number,
            remit.remit_amount                                                                      AS remit_amount,
            remit.return_rate_amount                                                                AS remit_return_rate_amount,
            process.apply_license_plate_deposit_info                                                AS process_apply_license_plate_deposit_info,
            process.bank_lend_record                                                                AS process_bank_lend_record

    from (select * from loan_order where id = #{orderId,jdbcType=BIGINT}) main_order
    left join loan_process process on main_order.id = process.order_id
    left join loan_customer customer on main_order.loan_customer_id = customer.id
    left join material_audit material on main_order.material_audit_id = material.id
    left join loan_base_info loan on main_order.loan_base_info_id = loan.id
    left join loan_car_info car on main_order.loan_car_info_id = car.id
    left join remit_details remit on main_order.remit_details_id = remit.id
    left join vehicle_information vehicle on main_order.vehicle_information_id = vehicle.id
    left join loan_financial_plan financial on main_order.loan_financial_plan_id = financial.id
    left join financial_product product on financial.financial_product_id = product.prod_id
    left join loan_credit_info bank_credit on customer.id = bank_credit.customer_id and bank_credit.type = 1
    left join loan_credit_info society_credit on customer.id = society_credit.customer_id and society_credit.type = 2
    left join employee salesman on loan.salesman_id = salesman.id
    left join partner partner on loan.partner_id = partner.id
    left join department department on partner.department_id = department.id


  </select>

    <!--贷款信息-->
    <select id="selectUniversalLoanInfo" parameterType="java.lang.Long" resultType="com.yunche.loan.domain.vo.UniversalLoanInfoVO" >
        select
                main_order.id                                                                       AS order_id,
                customer.id_card                                                                    AS customer_id_card,
                customer.name                                                                       AS customer_name,
                customer.mobile                                                                     AS customer_mobile,
                partner.name                                                                        AS partner_name,
                useGetAreaFullName(partner.area_id)                                                 AS partner_biz_area,
                salesman.name                                                                       AS salesman_name,
                car.gps_num                                                                         AS car_gps_num,
                car.car_key                                                                         AS car_key,
                financial.bank                                                                      AS financial_bank,
                financial.loan_time                                                                 AS financial_loan_time,
                financial.down_payment_ratio                                                        AS financial_down_payment_ratio,
                financial.financial_product_name                                                    AS financial_product_name,
                financial.sign_rate                                                                 AS financial_sign_rate,
                financial.loan_amount                                                               AS financial_loan_amount,
                financial.first_month_repay                                                         AS financial_first_month_repay,
                financial.cash_deposit                                                              AS financial_cash_deposit,
                financial.down_payment_money                                                        AS financial_down_payment_money,
                financial.bank_period_principal                                                     AS financial_bank_period_principal,
                financial.each_month_repay                                                          AS financial_each_month_repay,
                useGetBankFee(product.formula_id,financial.loan_amount,financial.sign_rate,useGetBankRate(financial.financial_product_id,financial.loan_time),financial.loan_time)
                                                                                                    AS financial_bank_fee,
                useCalculateStagingRatio(product.formula_id,financial.loan_amount,financial.sign_rate,useGetBankRate(financial.financial_product_id,financial.loan_time),financial.car_price)
                                                                                                    AS financial_bank_staging_ratio

        from (select * from loan_order where id = #{orderId,jdbcType=BIGINT}) main_order
        left join loan_process process on main_order.id = process.order_id
        left join loan_customer customer on main_order.loan_customer_id = customer.id
        left join loan_base_info loan on main_order.loan_base_info_id = loan.id
        left join loan_car_info car on main_order.loan_car_info_id = car.id
        left join loan_financial_plan financial on main_order.loan_financial_plan_id = financial.id
        left join financial_product product on financial.financial_product_id = product.prod_id
        left join employee salesman on loan.salesman_id = salesman.id
        left join partner partner on loan.partner_id = partner.id

    </select>

    <!--贷款车辆信息-->
    <select id="selectUniversalCarInfo" parameterType="java.lang.Long" resultType="com.yunche.loan.domain.vo.UniversalCarInfoVO" >
        select
            detail.price                                                            AS car_assess_price,
            brand.name                                                              AS car_brand_name,
            financial.car_price                                                     AS car_price,
            useGetCarName(car.car_detail_id)                                        AS car_name,
            car.vehicle_property                                                    AS car_vehicle_property,
            car.car_type                                                            AS car_type,
            vehicle.vehicle_identification_number                                   AS vehicle_vehicle_identification_number,
            vehicle.license_plate_number                                            AS vehicle_license_plate_number,
            vehicle.engine_number                                                   AS vehicle_engine_number,
            vehicle.apply_license_plate_area                                        AS vehicle_apply_license_plate_area,
            vehicle.registration_certificate_number                                 AS vehicle_registration_certificate_number,
            vehicle.color                                                           AS vehicle_color

        from (select * from loan_order where id = #{orderId,jdbcType=BIGINT}) main_order
        left join loan_car_info car on main_order.loan_car_info_id = car.id
        left join loan_financial_plan financial on main_order.loan_financial_plan_id = financial.id
        left join vehicle_information vehicle on main_order.vehicle_information_id = vehicle.id
        left join car_detail detail on car.car_detail_id = detail.id
        left join car_model model on detail.model_id = model.id
        left join car_brand brand on model.brand_id = brand.id
    </select>

    <!--共贷人信息-->
    <select id="selectUniversalRelationCustomer" parameterType="java.lang.Long" resultType="com.yunche.loan.domain.vo.UniversalRelationCustomerVO">
      select
            customer.cust_type                                                      AS customer_cust_type,
            customer.cust_relation                                                  AS customer_cust_relation,
            customer.name                                                           AS customer_name,
            customer.id_card                                                        AS customer_id_card,
            customer.income_certificate_company_name                                AS customer_income_certificate_company_name,
            customer.mobile                                                         AS customer_mobile,
            customer.address                                                        AS customer_address,
            customer.company_address                                                AS customer_company_address,
            customer.postcode                                                       AS customer_postcode,
            customer.company_phone                                                  AS customer_company_phone

      from (select * from loan_order where id = #{orderId,jdbcType=BIGINT}) main_order
      left join loan_customer customer on main_order.loan_customer_id = customer.principal_cust_id and cust_type !=0
    </select>

    <!--打款信息-->
    <select id="selectUniversalRemitDetails" parameterType="java.lang.Long" resultType="com.yunche.loan.domain.vo.UniversalRemitDetails">
      select
            remit.beneficiary_bank                                                                  AS remit_beneficiary_bank,
            remit.beneficiary_account                                                               AS remit_beneficiary_account,
            remit.beneficiary_account_number                                                        AS remit_beneficiary_account_number,
            remit.remit_amount                                                                      AS remit_amount,
            remit.return_rate_amount                                                                AS remit_return_rate_amount

      from (select * from loan_order where id = #{orderId,jdbcType=BIGINT}) main_order
      left join remit_details remit on main_order.remit_details_id = remit.id

    </select>

    <!--费用明细-->
    <select id="selectUniversalCostDetails" parameterType="java.lang.Long" resultType="com.yunche.loan.domain.vo.UniversalCostDetailsVO">
      select
             cost.service_fee                                AS cost_service_fee,
             cost.apply_license_plate_deposit_fee            AS cost_apply_license_plate_deposit_fee,
             cost.performance_fee                            AS cost_performance_fee,
             cost.install_gps_fee                            AS cost_install_gps_fee,
             cost.risk_fee                                   AS cost_risk_fee,
             cost.fair_assess_fee                            AS cost_fair_assess_fee,
             cost.apply_license_plate_out_province_fee       AS cost_apply_license_plate_out_province_fee,
             cost.based_margin_fee                           AS cost_based_margin_fee,
             cost.service_fee_type                           AS cost_service_fee_type,
             cost.apply_license_plate_deposit_fee_type       AS cost_apply_license_plate_deposit_fee_type,
             cost.performance_fee_type                       AS cost_performance_fee_type,
             cost.install_gps_fee_type                       AS cost_install_gps_fee_type,
             cost.risk_fee_type                              AS cost_risk_fee_type,
             cost.fair_assess_fee_type                       AS cost_fair_assess_fee_type,
             cost.apply_license_plate_out_province_fee_type  AS cost_apply_license_plate_out_province_fee_type,
             cost.based_margin_fee_type                      AS cost_based_margin_fee_type,
             remit.remit_amount                              AS remit_amount,
             remit.return_rate_amount                        AS remit_return_rate_amount

      from (select * from loan_order where id = #{orderId,jdbcType=BIGINT}) main_order
      left join cost_details cost on main_order.cost_details_id = cost.id
      left join remit_details remit on main_order.remit_details_id = remit.id

    </select>

    <!--征信结果-->
  <select id="selectUniversalCreditInfo" resultType="com.yunche.loan.domain.vo.UniversalCreditInfoVO" parameterType="java.lang.Long" >
    select
        customer.cust_type                	AS customer_cust_type,
        customer.name					  	AS customer_name,
		bank.info			      	        AS bank_info,
        bank.result		          			AS bank_result,
        process_bank.credit_result         	AS process_bank_credit_result,
        process_bank.credit_info           	AS process_bank_credit_info,
        process_bank.add_condition         	AS process_bank_add_condition,
        society.info		          		AS society_info,
        society.result             			AS society_result,
        process_society.credit_result     	AS process_society_credit_result,
        process_society.credit_info       	AS process_society_credit_info,
        process_society.add_condition      	AS process_society_add_condition


    from (select * from loan_order where id = #{orderId,jdbcType=BIGINT}) main_order
    left join loan_customer customer on main_order.loan_customer_id = customer.principal_cust_id
    left join loan_credit_info bank on customer.id = bank.customer_id and bank.type = 1
    left join loan_credit_info society on customer.id = society.customer_id and society.type = 2
    left join (select * from loan_process_log  where order_id =  #{orderId,jdbcType=BIGINT} and task_definition_key = 'usertask_bank_credit_record' order by create_time LIMIT 1) process_bank on process_bank.order_id = main_order.id
    left join (select * from loan_process_log  where order_id  = #{orderId,jdbcType=BIGINT} and task_definition_key = 'usertask_social_credit_record' order by create_time LIMIT 1) process_society on process_society.order_id = main_order.id
  </select>

    <!--上门家访问报告-->
    <select id="selectUniversalHomeVisitInfo" resultType="com.yunche.loan.domain.vo.UniversalHomeVisitInfoVO" parameterType="java.lang.Long" >
        select
					salesman.name                                    AS salesman_name,
					DATE_FORMAT(home.visit_date,'%Y-%m-%d %H:%i:%S') AS home_visit_date,
					home.visit_address								 AS home_visit_address,
					home.survey_report								 AS home_survey_report

		from (select * from loan_order where id = #{orderId,jdbcType=BIGINT}) main_order
		left join loan_home_visit home on main_order.loan_home_visit_id = home.id
		left join employee salesman on home.visit_salesman_id = salesman.id

    </select>

    <!--资料增补-->
    <select id="selectUniversalSupplementInfo" resultType="com.yunche.loan.domain.vo.UniversalSupplementInfoVO" parameterType="java.lang.Long">

        select
            supplement.remark						AS  supplement_remark,
            supplement.content					    AS  supplement_content,
            supplement.info							AS 	supplement_info,
            supplement.type							AS  supplement_type

        from (select * from loan_order where id = #{orderId,jdbcType=BIGINT}) main_order
        left join loan_info_supplement supplement on main_order.id = supplement.id
        order by end_time desc LIMIT 1
    </select>

    <!--客户信息-->
    <select id="selectUniversalCustomer" resultType="com.yunche.loan.domain.vo.UniversalCustomerVO" parameterType="java.lang.Long" >
    select
        o.id                      AS order_id,
        c.id                      AS customer_id,
        c.cust_type               AS cust_type,
        c.name                    AS name,
        c.id_card                 AS id_card,
        c.mobile                  AS mobile,
        c.cust_relation           AS cust_relation,
        c.sex                     AS sex,
        c.company_name            AS company_name,
        c.company_address         AS company_address,
        c.education               AS education,
        c.month_income            AS month_income,
        c.address                 AS address,
        c.postcode                AS postcode,
        c.working_years           AS working_years,
        c.duty                    AS duty,
        case when
            cb.result   is null
        then
            cb.result else 1 end  AS bank_result,
		case when
            cs.result  is null
        then
            cs.result else 2 end  AS society_result

    from (select * from loan_order where id = #{orderId,jdbcType=BIGINT}) o

    left join loan_customer c on o.loan_customer_id= c.id or o.loan_customer_id = c.principal_cust_id

    left join loan_credit_info cb on cb.customer_id = c.id and cb.type = 1

    left join loan_credit_info cs on cb.customer_id = c.id and cs.type = 2

</select>

    <!--客户信息-->
    <select id="selectUniversalCustomerDetail" resultType="com.yunche.loan.domain.vo.UniversalCustomerDetailVO" parameterType="java.lang.Long" >
              select
                t.id                AS customer_id,
                t.cust_type         AS cust_type,
                t.name              AS name,
                t.id_card           AS id_card,
                t.mobile            AS mobile,
                t.age               AS age,
                t.sex               AS sex,
                t.apply_date        AS apply_date,
                t.address           AS address,
                t.marry             AS marry,
                t.identity_address  AS identity_address,
                t.mobile_area       AS mobile_area,
                t.education         AS education,
                t.company_name      AS company_name,
                t.company_address   AS company_address,
                t.company_phone     AS company_phone,
                t.month_income      AS month_income,
                t.house_type        AS house_type,
                t.house_owner       AS house_owner,
                t.house_feature     AS house_feature,
                t.house_address     AS house_address,
                t.postcode          AS postcode,
                t.working_years     AS working_years,
                t.duty              AS duty,
                cb.gmt_create       AS bank_gmt_create,
                cb.result           AS bank_result,
                cb.info             AS bank_result_info,
                cs.gmt_create       AS society_gmt_create,
                cs.result           AS society_result,
                cs.info             AS society_result_info
        from
        (select * from loan_customer where id = #{customerId,jdbcType=BIGINT}) t

        left join loan_credit_info cb on cb.customer_id = t.id and cb.type = 1

        left join loan_credit_info cs on cs.customer_id = t.id and cs.type = 2
    </select>

    <!--客户附件信息-->
    <select id="selectUniversalCustomerFile" resultType="com.yunche.loan.domain.vo.UniversalCustomerFileVO" parameterType="java.lang.Long" >
    select
            path                      AS urls,
            type                      AS type,
            useFileTypeCastName(type) AS name
    from  loan_file  where customer_id = #{customerId,jdbcType=BIGINT}
    </select>



    <!--资料增补-->
    <select id="selectUniversalMaterialRecord" resultType="com.yunche.loan.domain.vo.UniversalMaterialRecordVO" parameterType="java.lang.Long" >
    select
            path                      AS urls,
            type                      AS type,
            useFileTypeCastName(type) AS name
    from loan_file where customer_id = (select loan_customer_id from loan_order where id = #{orderId,jdbcType=BIGINT}) and upload_type = 2
  </select>

    <!--资料增补根据type-->
    <select id="selectUniversalMaterialRecordByType" resultType="com.yunche.loan.domain.vo.UniversalMaterialRecordVO">
    select
            path                      AS urls,
            type                      AS type,
            useFileTypeCastName(type) AS name
    from loan_file where customer_id = (select loan_customer_id from loan_order where id = #{orderId,jdbcType=BIGINT}) and upload_type = #{uploadType,jdbcType=TINYINT}
  </select>

    <!--关联订单-->
    <select id="selectUniversalRelevanceOrderId" parameterType="java.lang.Long" resultType="java.lang.Long">
            select o.id from loan_order o
              inner join
            (select distinct id from loan_customer where principal_cust_id = (select loan_customer_id from loan_order where id = #{orderId,jdbcType=BIGINT})) t
            on t.id = o.loan_customer_id
    </select>

    <!--审核备注-->
    <select id="selectUniversalApprovalInfo" resultType="com.yunche.loan.domain.vo.UniversalApprovalInfo">
       select action,info from loan_process_log where task_definition_key =  #{taskDefinitionKey,jdbcType=VARCHAR} and order_id = #{orderId,jdbcType=BIGINT} order by create_time desc limit 1
    </select>

    <!--=============================================end===================================================-->


  <!--保险客户信息-->
  <select id="selectInsuranceCustomer" resultType="com.yunche.loan.domain.vo.InsuranceCustomerVO" parameterType="java.lang.Long" >
      select
              o.id                              AS order_id,
              i.id                              AS insurance_info_id,
              c.id                              AS customer_id,
              c.name                            AS cname,
              c.id_card                         AS id_card,
              e.name                            AS ename,
              p.name                            AS pname,
              i.insurance_year                  AS insurance_year,
              i.issue_bills_date                AS issue_bills_date,
              c.address                         AS residential_address,
              (select sum(insurance_amount) from insurance_relevance where insurance_info_id = id )
                                                AS total_insurance_amount

      from
            (select * from loan_order where id = #{orderId,jdbcType=BIGINT}) o
                left join insurance_info i on i.order_id = o.id
                left join loan_customer c on c.id = o.loan_customer_id
                left join loan_base_info b on b.id = o.loan_base_info_id
                left join employee e on e.id = b.salesman_id
                left join partner p on p.id = b.partner_id

    ORDER BY i.issue_bills_date asc


  </select>

    <!--保险客户信息-->
    <select id="selectInsuranceCustomerNormalizeInsuranceYear" resultType="com.yunche.loan.domain.vo.InsuranceCustomerVO" parameterType="java.lang.Long" >
     select
              o.id                    AS order_id,
              i.id                    AS insurance_info_id,
              c.id                    AS customer_id,
              c.name                  AS cname,
              c.id_card               AS id_card,
              e.name                  AS ename,
              p.name                  AS pname,
              i.insurance_year        AS insurance_year,
              i.issue_bills_date      AS issue_bills_date,
              c.address               AS residential_address,
              (select sum(insurance_amount) from insurance_relevance where insurance_info_id = id )
                                      AS total_insurance_amount

      from
            (select * from loan_order where id = #{orderId,jdbcType=BIGINT}) o
                left join insurance_info i on i.order_id = o.id and i.insurance_year = 1
                left join loan_customer c on c.id = o.loan_customer_id
                left join loan_base_info b on b.id = o.loan_base_info_id
                left join employee e on e.id = b.salesman_id
                left join partner p on p.id = b.partner_id
    ORDER BY i.issue_bills_date asc

  </select>

  <!--保险相关信息-->
  <select id="selectInsuranceRelevance" resultType="com.yunche.loan.domain.vo.InsuranceRelevanceVO" parameterType="java.lang.Long" >

    select
             insurance_info_id      AS insurance_info_id,
             insurance_company_name AS insurance_company_name,
             insurance_number       AS insurance_number,
             insurance_amount       AS insurance_amount,
             start_date             AS start_date,
             end_date               AS end_date,
             insurance_type         AS insurance_type

    from insurance_relevance where insurance_info_id = #{insuranceInfoId,jdbcType=BIGINT}

  </select>

  <!--金融方案-->
  <select id="selectFinancialScheme" resultType="com.yunche.loan.domain.vo.FinancialSchemeVO" parameterType="java.lang.Long" >
    select
             o.id                                 AS order_id,
             c.id                                 AS customer_id,
             c.name                               AS cname,
             c.id_card                            AS id_card,
             f.financial_product_name             AS financial_product_name,
             h.license_plate_number               AS license_plate_number,
             h.registration_certificate_number    AS registration_certificate_number,
             h.apply_license_plate_date           AS apply_license_plate_date,
             a.apply_license_plate_deposit_date   AS apply_license_plate_deposit_date,
             f.loan_time                          AS loan_time,
             f.car_price                          AS car_price,
             b.bank                               AS bank,
             f.sign_rate                          AS sign_rate,
             f.down_payment_money                 AS down_payment_money,
             f.loan_amount                        AS loan_amount,
             f.down_payment_ratio                 AS down_payment_ratio,
             f.bank_period_principal              AS bank_period_principal,
             f.bank_fee                           AS bank_fee,
             f.principal_interest_sum             AS principal_interest_sum,
             f.first_month_repay                  AS first_month_repay,
             f.each_month_repay                   AS each_month_repay

    from (select * from loan_order where id = #{orderId,jdbcType=BIGINT}) o

    left join loan_customer c on o.loan_customer_id= c.id

    left join loan_base_info b on o.loan_base_info_id = b.id

    left join loan_car_info i on o.loan_car_info_id = i.id

    left join loan_financial_plan f on o.loan_financial_plan_id = f.id

    left join cost_details d on o.cost_details_id = d.id

    left join remit_details r on o.remit_details_id = r.id

    left join vehicle_information h on o.vehicle_information_id = h.id

    left join apply_license_plate_deposit_info a on o.apply_license_plate_deposit_info_id = a.id

    left join material_audit m on o.material_audit_id = m.id

    left join loan_home_visit v on o.loan_home_visit_id = v.id


  </select>

    <!--计算明细的信息-->
    <select id="selectCostCalculateInfo" resultType="com.yunche.loan.domain.vo.CostCalculateInfoVO" parameterType="java.lang.Long" >
        select
                f.bank_period_principal AS bank_period_principal,
                p.pay_month             AS pay_month

        from (select * from loan_order where id = #{orderId,jdbcType=BIGINT}) o

        left join loan_financial_plan f on o.loan_financial_plan_id = f.id

        left join partner p       on p.id = b.partner_id
    </select>

    <select id="selectGpsByOrderId" resultType="com.yunche.loan.domain.vo.GpsVO" parameterType="java.lang.Long" >
        select
                order_id,gps_number AS gps_number
        from install_gps
        where order_id = #{orderId,jdbcType=BIGINT}
    </select>



    <select id="selectOrderIdByIDCard" resultType="java.lang.Long" >
        SELECT
         id
        FROM
        loan_order
        WHERE
        loan_customer_id = (
        SELECT
        id
        FROM
        loan_customer
        WHERE
        id_card =#{idCard}
        AND cust_type = '1'
        )
    </select>

    <select id="selectBankLendRecordDetail" resultType="com.yunche.loan.domain.vo.BankLendRecordVO" parameterType="java.lang.Long">
        SELECT
        a.id AS orderId,
        b.id_card AS idCard,
        b.name AS principalLenderName,
        h.name AS salesman,
        e. NAME AS departmentName,
        a.loan_customer_id AS customerId,
        a.gmt_create AS gmtCreate,
        c.bank,
        (select
        case when
        END_TIME_ = null
        then null
        else
        DATE_FORMAT(END_TIME_,'%Y-%m-%d %H:%i:%S')
        end
        from act_hi_taskinst
        where PROC_INST_ID_ = a.process_inst_id
        and TASK_DEF_KEY_ = 'usertask_bank_lend_record'
        order by START_TIME_
        desc limit 1) AS remitGmtCreate,
        f.lend_date AS lendDate,
        f.lend_amount AS lendAmount,
        d.name AS partnerName
        FROM
        loan_order a
        LEFT JOIN  bank_lend_record f on a.bank_lend_record_id=f.id
        LEFT JOIN loan_customer b ON a.loan_customer_id = b.id
        LEFT JOIN loan_base_info c ON a.loan_base_info_id = c.id
        LEFT JOIN employee h ON h.id=c.salesman_id
        LEFT JOIN partner d ON c.partner_id = d.id
        LEFT JOIN department e ON d.department_id = e.id
        WHERE
        a.id =#{orderId}
    </select>


    <select id="selectBankCardRecordDetail" resultType="com.yunche.loan.domain.vo.BankCardRecordVO" parameterType="java.lang.Long">
        SELECT
        a.id AS orderId,
        b.id_card AS idCard,
        b.name AS principalLenderName,
        h.name AS salesman,
        e.NAME AS departmentName,
        a.loan_customer_id AS customerId,
        a.gmt_create AS gmtCreate,
        c.bank,
        f.lend_date AS lendDate,
        g.billing_date AS billingDate,
        g.first_billing_date AS firstBillingDate,
        g.repay_date AS repayDate,
        g.first_repayment_date AS firstRepaymentDate,
        g.repay_card_id AS repayCardId,
        g.receive_date AS receiveDate,
        g.sendee,
        d.name  AS partnerName
        FROM
        loan_order a
        LEFT JOIN  bank_card_record g  on a.id= g.order_id
        LEFT JOIN  bank_lend_record f on a.bank_lend_record_id=f.id
        LEFT JOIN loan_customer b ON a.loan_customer_id = b.id
        LEFT JOIN loan_base_info c ON a.loan_base_info_id = c.id
        LEFT JOIN employee h ON  c.salesman_id=h.id
        LEFT JOIN partner d ON c.partner_id = d.id
        LEFT JOIN department e ON d.department_id = e.id
        WHERE
        a.id =#{orderId}
    </select>
</mapper>